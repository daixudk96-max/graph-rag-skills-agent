--------------------------------------------------
CWD: C:\github\graph-rag-agent
DEBUG: OPENAI_API_KEY loaded: sk-b268d...4c84
DEBUG: OPENAI_BASE_URL: https://dashscope.aliyuncs.com/compatible-mode/v1
DEBUG: OPENAI_LLM_MODEL: qwen-flash
--------------------------------------------------
+-------------------------------------+
| ATOM 时序知识图谱构建               |
| 使用 ATOM 提取器和 Neo4j 时序写入器 |
+-------------------------------------+

Step 1: 加载文本块
从文本文件加载: test_input.txt
  [OK] 加载 1 个文本块

Step 2: 构建时序知识图谱
C:\Python311\Lib\site-packages\torch\cuda\__init__.py:61: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.
  import pynvml  # type: ignore[import]
INFO: Loading faiss with AVX512 support.
INFO: Could not load library with AVX512 support due to:
ModuleNotFoundError("No module named 'faiss.swigfaiss_avx512'")
INFO: Loading faiss with AVX2 support.
INFO: Successfully loaded faiss with AVX2 support.

初始化 ATOM 适配器...
--- Logging error ---
Traceback (most recent call last):
  File "C:\Python311\Lib\logging\__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
UnicodeEncodeError: 'gbk' codec can't encode character '\U0001f50d' in position 87: illegal multibyte sequence
Call stack:
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 190, in build_temporal_knowledge_graph
    adapter = AtomExtractionAdapter(
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 81, in __init__
    self.atom = Atom(
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 28, in __init__
    self.llm_output_parser = LangchainOutputParser(llm_model=llm_model, embeddings_model=embeddings_model)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 98, in __init__
    logger.info(f"\U0001f50d Detected LLM Provider: {self.config.name}")
Message: '\U0001f50d Detected LLM Provider: OpenAI'
Arguments: ()
--- Logging error ---
Traceback (most recent call last):
  File "C:\Python311\Lib\logging\__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
UnicodeEncodeError: 'gbk' codec can't encode character '\U0001f4ca' in position 87: illegal multibyte sequence
Call stack:
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 190, in build_temporal_knowledge_graph
    adapter = AtomExtractionAdapter(
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 81, in __init__
    self.atom = Atom(
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 28, in __init__
    self.llm_output_parser = LangchainOutputParser(llm_model=llm_model, embeddings_model=embeddings_model)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 99, in __init__
    logger.info(f"\U0001f4ca Rate Limiting Config: {self.config.max_elements_per_batch} requests/batch, "
Message: '\U0001f4ca Rate Limiting Config: 40 requests/batch, 8000 tokens/batch'
Arguments: ()
INFO: AtomExtractionAdapter initialized with ent_threshold=0.8, rel_threshold=0.7, max_workers=8
  [OK] LLM: qwen-flash
  [OK] Embeddings: 已初始化
  [OK] 观察时间: 2025-12-14T17:02:51.544238+00:00

提取时序知识图谱 (1 个文本块)...
INFO: Extracted 1 atomic facts from 1 chunks
[2025-12-15 01:02:51] [    INFO] [itext2kg.itext2kg.atom.atom] ------- Extracting Quintuples---------
--- Logging error ---
Traceback (most recent call last):
  File "C:\Python311\Lib\logging\__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
UnicodeEncodeError: 'gbk' codec can't encode character '\U0001f4e6' in position 87: illegal multibyte sequence
Call stack:
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 212, in build_temporal_knowledge_graph
    temporal_kg = adapter.extract_from_chunks_sync(
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 203, in extract_from_chunks_sync
    return loop.run_until_complete(
  File "C:\Python311\Lib\asyncio\base_events.py", line 641, in run_until_complete
    self.run_forever()
  File "C:\Python311\Lib\asyncio\windows_events.py", line 321, in run_forever
    super().run_forever()
  File "C:\Python311\Lib\asyncio\base_events.py", line 608, in run_forever
    self._run_once()
  File "C:\Python311\Lib\asyncio\base_events.py", line 1936, in _run_once
    handle._run()
  File "C:\Python311\Lib\asyncio\events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 128, in extract_from_chunks
    atom_kg = await self.atom.build_graph(
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 168, in build_graph
    relationships = await self.llm_output_parser.extract_information_as_json_for_context(output_data_structure=RelationshipsExtractor, contexts=atomic_facts, system_query=system_query+examples)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 274, in extract_information_as_json_for_context
    batches = self.split_prompts_into_batches(all_prompts)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 220, in split_prompts_into_batches
    logger.info(f"\U0001f4e6 Split {len(prompts):,} prompts into {len(batches)} batches for {self.config.name} API")
Message: '\U0001f4e6 Split 1 prompts into 1 batches for OpenAI API'
Arguments: ()
--- Logging error ---
Traceback (most recent call last):
  File "C:\Python311\Lib\logging\__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
UnicodeEncodeError: 'gbk' codec can't encode character '\U0001f680' in position 87: illegal multibyte sequence
Call stack:
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 212, in build_temporal_knowledge_graph
    temporal_kg = adapter.extract_from_chunks_sync(
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 203, in extract_from_chunks_sync
    return loop.run_until_complete(
  File "C:\Python311\Lib\asyncio\base_events.py", line 641, in run_until_complete
    self.run_forever()
  File "C:\Python311\Lib\asyncio\windows_events.py", line 321, in run_forever
    super().run_forever()
  File "C:\Python311\Lib\asyncio\base_events.py", line 608, in run_forever
    self._run_once()
  File "C:\Python311\Lib\asyncio\base_events.py", line 1936, in _run_once
    handle._run()
  File "C:\Python311\Lib\asyncio\events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 128, in extract_from_chunks
    atom_kg = await self.atom.build_graph(
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 168, in build_graph
    relationships = await self.llm_output_parser.extract_information_as_json_for_context(output_data_structure=RelationshipsExtractor, contexts=atomic_facts, system_query=system_query+examples)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 275, in extract_information_as_json_for_context
    logger.info(f"\U0001f680 Processing {len(contexts):,} contexts in {len(batches)} batches for {self.config.name} API")
Message: '\U0001f680 Processing 1 contexts in 1 batches for OpenAI API'
Arguments: ()
--- Logging error ---
Traceback (most recent call last):
  File "C:\Python311\Lib\logging\__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
UnicodeEncodeError: 'gbk' codec can't encode character '\U0001f4cb' in position 87: illegal multibyte sequence
Call stack:
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 212, in build_temporal_knowledge_graph
    temporal_kg = adapter.extract_from_chunks_sync(
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 203, in extract_from_chunks_sync
    return loop.run_until_complete(
  File "C:\Python311\Lib\asyncio\base_events.py", line 641, in run_until_complete
    self.run_forever()
  File "C:\Python311\Lib\asyncio\windows_events.py", line 321, in run_forever
    super().run_forever()
  File "C:\Python311\Lib\asyncio\base_events.py", line 608, in run_forever
    self._run_once()
  File "C:\Python311\Lib\asyncio\base_events.py", line 1936, in _run_once
    handle._run()
  File "C:\Python311\Lib\asyncio\events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 128, in extract_from_chunks
    atom_kg = await self.atom.build_graph(
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 168, in build_graph
    relationships = await self.llm_output_parser.extract_information_as_json_for_context(output_data_structure=RelationshipsExtractor, contexts=atomic_facts, system_query=system_query+examples)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 288, in extract_information_as_json_for_context
    logger.info(f"\U0001f4cb Processing batch {i+1}/{len(batches)} with {len(batch)} requests ({self.config.name})")
Message: '\U0001f4cb Processing batch 1/1 with 1 requests (OpenAI)'
Arguments: ()
INFO: HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions "HTTP/1.1 200 OK"
--- Logging error ---
Traceback (most recent call last):
  File "C:\Python311\Lib\logging\__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
UnicodeEncodeError: 'gbk' codec can't encode character '\u2705' in position 87: illegal multibyte sequence
Call stack:
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 212, in build_temporal_knowledge_graph
    temporal_kg = adapter.extract_from_chunks_sync(
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 203, in extract_from_chunks_sync
    return loop.run_until_complete(
  File "C:\Python311\Lib\asyncio\base_events.py", line 641, in run_until_complete
    self.run_forever()
  File "C:\Python311\Lib\asyncio\windows_events.py", line 321, in run_forever
    super().run_forever()
  File "C:\Python311\Lib\asyncio\base_events.py", line 608, in run_forever
    self._run_once()
  File "C:\Python311\Lib\asyncio\base_events.py", line 1936, in _run_once
    handle._run()
  File "C:\Python311\Lib\asyncio\events.py", line 84, in _run
    self._context.run(self._callback, *self._args)
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 128, in extract_from_chunks
    atom_kg = await self.atom.build_graph(
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 168, in build_graph
    relationships = await self.llm_output_parser.extract_information_as_json_for_context(output_data_structure=RelationshipsExtractor, contexts=atomic_facts, system_query=system_query+examples)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 388, in extract_information_as_json_for_context
    logger.info(f"\u2705 Successfully processed all {len(outputs):,} requests for {self.config.name}")
Message: '\u2705 Successfully processed all 1 requests for OpenAI'
Arguments: ()
[2025-12-15 01:02:54] [    INFO] [itext2kg.itext2kg.atom.atom] ------- Building Atomic KGs---------
INFO: HTTP Request: POST https://dashscope.aliyuncs.com/compatible-mode/v1/embeddings "HTTP/1.1 400 Bad Request"
ERROR: ATOM build_graph failed: Error code: 400 - {'error': {'message': '<400> InternalError.Algo.InvalidParameter: Value error, contents is neither str nor list of str.: input.contents', 'type': 'InvalidParameter', 'param': None, 'code': 'InvalidParameter'}, 'id': '59866357-8d13-4574-990e-1ce62ce1d0e0', 'request_id': '59866357-8d13-4574-990e-1ce62ce1d0e0'}
Traceback (most recent call last):
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 212, in build_temporal_knowledge_graph
    temporal_kg = adapter.extract_from_chunks_sync(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 203, in extract_from_chunks_sync
    return loop.run_until_complete(
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\asyncio\base_events.py", line 654, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "C:\github\graph-rag-agent\graphrag_agent\graph\extraction\atom_adapter.py", line 128, in extract_from_chunks
    atom_kg = await self.atom.build_graph(
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 172, in build_graph
    atomic_kgs = await asyncio.gather(*list(map(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\atom.py", line 96, in build_atomic_kg_from_quintuples
    await temp_kg.embed_entities(embeddings_function=self.llm_output_parser.calculate_embeddings, entity_name_weight=entity_name_weight, entity_label_weight=entity_label_weight)
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\atom\models\knowledge_graph.py", line 39, in embed_entities
    label_embeddings = await embeddings_function(labels)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\github\graph-rag-agent\itext2kg\itext2kg\llm_output_parsing\langchain_output_parser.py", line 228, in calculate_embeddings
    embeddings = await self.embeddings_model.aembed_documents(text)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\langchain_openai\embeddings\base.py", line 618, in aembed_documents
    return await self._aget_len_safe_embeddings(texts, engine=engine)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\langchain_openai\embeddings\base.py", line 534, in _aget_len_safe_embeddings
    response = await self.async_client.create(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\openai\resources\embeddings.py", line 251, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\openai\_base_client.py", line 1794, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\openai\_base_client.py", line 1594, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': '<400> InternalError.Algo.InvalidParameter: Value error, contents is neither str nor list of str.: input.contents', 'type': 'InvalidParameter', 'param': None, 'code': 'InvalidParameter'}, 'id': '59866357-8d13-4574-990e-1ce62ce1d0e0', 'request_id': '59866357-8d13-4574-990e-1ce62ce1d0e0'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 352, in main
    temporal_kg = build_temporal_knowledge_graph(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 205, in build_temporal_knowledge_graph
    with Progress(
  File "C:\Python311\Lib\site-packages\rich\progress.py", line 1189, in __exit__
    self.stop()
  File "C:\Python311\Lib\site-packages\rich\progress.py", line 1175, in stop
    self.live.stop()
  File "C:\Python311\Lib\site-packages\rich\live.py", line 162, in stop
    with self.console:
  File "C:\Python311\Lib\site-packages\rich\console.py", line 870, in __exit__
    self._exit_buffer()
  File "C:\Python311\Lib\site-packages\rich\console.py", line 826, in _exit_buffer
    self._check_buffer()
  File "C:\Python311\Lib\site-packages\rich\console.py", line 2038, in _check_buffer
    self._write_buffer()
  File "C:\Python311\Lib\site-packages\rich\console.py", line 2074, in _write_buffer
    legacy_windows_render(buffer, LegacyWindowsTerm(self.file))
  File "C:\Python311\Lib\site-packages\rich\_windows_renderer.py", line 17, in legacy_windows_render
    term.write_styled(text, style)
  File "C:\Python311\Lib\site-packages\rich\_win32_console.py", line 441, in write_styled
    self.write_text(text)
  File "C:\Python311\Lib\site-packages\rich\_win32_console.py", line 402, in write_text
    self.write(text)
UnicodeEncodeError: 'gbk' codec can't encode character '\u2819' in position 0: illegal multibyte sequence

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 452, in <module>
    main()
  File "C:\github\graph-rag-agent\build_kg_atom.py", line 380, in main
    console.print(f"\n[red]错误: {e}[/red]")
  File "C:\Python311\Lib\site-packages\rich\console.py", line 1697, in print
    with self:
  File "C:\Python311\Lib\site-packages\rich\console.py", line 870, in __exit__
    self._exit_buffer()
  File "C:\Python311\Lib\site-packages\rich\console.py", line 826, in _exit_buffer
    self._check_buffer()
  File "C:\Python311\Lib\site-packages\rich\console.py", line 2038, in _check_buffer
    self._write_buffer()
  File "C:\Python311\Lib\site-packages\rich\console.py", line 2074, in _write_buffer
    legacy_windows_render(buffer, LegacyWindowsTerm(self.file))
  File "C:\Python311\Lib\site-packages\rich\_windows_renderer.py", line 17, in legacy_windows_render
    term.write_styled(text, style)
  File "C:\Python311\Lib\site-packages\rich\_win32_console.py", line 441, in write_styled
    self.write_text(text)
  File "C:\Python311\Lib\site-packages\rich\_win32_console.py", line 402, in write_text
    self.write(text)
UnicodeEncodeError: 'gbk' codec can't encode character '\u2819' in position 0: illegal multibyte sequence
